meta {
  name: Create Delivery (Direct Sale)
  type: http
  seq: 2
}

post {
  url: {{url}}/deliveries
  body: json
  auth: none
}

body:json {
  {
    "delivery_number": "DEL-2026-002",
    "delivery_date": "2026-01-10T14:00:00Z",
    "status": "delivered",
    "delivery_address": "Cliente Walk-in",
    "notes": "Venta directa en mostrador",
    "user_id": 1,
    "items": [
      {
        "product_id": 3,
        "item_id": 15,
        "quantity_delivered": 1,
        "unit_price": 8000,
        "notes": "Monitor serial XYZ789"
      },
      {
        "product_id": 4,
        "quantity_delivered": 20,
        "unit_price": 5.5,
        "notes": "Mouse pads"
      }
    ]
  }
}

docs {
  # Crear Entrega DIRECTA (Sin Orden de Venta)
  
  ## Concepto:
  Similar a crear **purchase sin purchase order**:
  - Venta directa del inventario
  - No requiere orden previa
  - Items pasan de `available` â†’ `sold` DIRECTAMENTE
  
  ## CuÃ¡ndo Usar:
  - Ventas en mostrador
  - Clientes walk-in
  - Ventas urgentes sin proceso de orden
  - Salidas de inventario directas
  
  ## Proceso:
  1. Valida existencia de productos
  2. Valida disponibilidad de items (`status: available`)
  3. **Marca items como SOLD DIRECTAMENTE**:
     - `available` â†’ `sold`
  4. Crea la entrega
  5. NO hay orden asociada (`sales_order_id: null`)
  
  ## Diferencia Clave:
  ```
  CON Orden:
  available â†’ reserved (orden) â†’ sold (entrega)
  
  SIN Orden:
  available â†’ sold (entrega directa) âš¡
  ```
  
  ## Items del Array:
  
  ### Item Serializado (venta directa):
  ```json
  {
    "product_id": 3,
    "item_id": 15,              // â† Item especÃ­fico disponible
    "quantity_delivered": 1,
    "unit_price": 8000
  }
  ```
  - NO se especifica `sales_order_item_id`
  - Item debe estar `available` o `reserved`
  
  ### Item NO Serializado (venta directa):
  ```json
  {
    "product_id": 4,
    "quantity_delivered": 20,   // â† Cantidad del inventario
    "unit_price": 5.5
  }
  ```
  - NO se especifica `item_id`
  - Toma N items disponibles del producto
  
  ## Validaciones:
  - âœ… Producto existe
  - âœ… Items estÃ¡n disponibles (`status: available`)
  - âœ… Stock suficiente para no serializados
  - âœ… Item no estÃ¡ ya vendido
  
  ## Errores Comunes:
  
  ### Stock insuficiente:
  ```json
  {
    "statusCode": 400,
    "message": "Stock insuficiente para producto X. Disponible: 10, Solicitado: 20"
  }
  ```
  
  ### Item no disponible:
  ```json
  {
    "statusCode": 409,
    "message": "Item XYZ no estÃ¡ disponible (estado: sold)"
  }
  ```
  
  ## Ventajas:
  - âš¡ MÃ¡s rÃ¡pido (sin crear orden)
  - ğŸ’° Ideal para ventas en efectivo
  - ğŸ“¦ Salida inmediata de inventario
  - ğŸ¯ Proceso simplificado
  
  ## Resultado:
  - Items pasan de `available` â†’ `sold`
  - Se crea la entrega
  - NO hay orden asociada
  - Items salen del inventario inmediatamente
}
